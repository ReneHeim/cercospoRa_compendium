---
title: "07_susceptibility_estimation"
author: "Paul Melloy"
date: "`r Sys.Date()`"
output: html_document
---

This file explains the equation for converting the bbch susceptibility rating
scale to a cDIV threshold which is used to determine the earliest estimated
epidemic onset time in the `cercospoRa` negative prognosis model

## Data  

This data is transcribed from Table 1 of [Wolf and Verreet (2005)](https://apsjournals.apsnet.org/doi/abs/10.1094/PHYTO-95-0269)

```{r data}
Table1 <- data.frame(cultivar = c(rep("Ribella", 13),
                                 rep("Patricia",11),
                                 rep("Corinna", 16),
                                 rep("Tatjana", 3),
                                 rep("Cyntia", 2),
                                 rep("Achat", 2),
                                 rep("Elan", 3),
                                 rep("Steffi", 4),
                                 rep("Meta", 6),
                                 rep("Evita", 3),
                                 rep("Hilma", 3),
                                 rep("Orbis",3)),
                    bbch = c(rep(4, 13),
                             rep(4, 11),
                             rep(4, 16),
                             rep(4, 3),
                             rep(4, 2),
                             rep(4, 2),
                             rep(5, 3),
                             rep(5, 4),
                             rep(6, 6),
                             rep(5, 3),
                             rep(5, 3),
                             rep(5, 3)),
                    susceptibility = c(rep("High", 13),
                                   rep("High", 11),
                                   rep("High", 16),
                                   rep("High", 3),
                                   rep("High", 2),
                                   rep("High", 2),
                                   rep("Low", 3),
                                   rep("Low", 4),
                                   rep("Low", 6),
                                   rep("Low", 3),
                                   rep("Low", 3),
                                   rep("Low", 3))
  )
```

Have a quick look at the data.

```{r}
plot(as.factor(Table1$susceptibility), Table1$bbch, 
     xlab = "Susceptibility Category", ylab = "BBCH susceptibility scale")
```

## Model susceptibility data  

We need to create an equation to estimate what cumulative DIV thresholds are for 
each level on the 
[BBCH scale](https://www.bundessortenamt.de/bsa/media/Files/BSL/bsl_getreide_2024.pdf).  

Using the data published in 
[Wolf and Verreet (2005), Phytopathology](https://apsjournals.apsnet.org/doi/abs/10.1094/PHYTO-95-0269) 
we will model the relationship between classed into "High" and "Low" 
Susceptibility, as raw data on each of the cultivars were not published.  

We will use a basic linear model, which at it's heart is an ANOVA to find the 
coefficient, which is the change in cDIV for each BBCH level.

```{r}
sus_mod <- stats::lm(bbch ~ as.factor(susceptibility), data = Table1)
summary(sus_mod)
```

Next lets consider the values described in the text of the Wolf and Vereet paper.

First we set the minimum cDIV values when epidemic onset was observed in each 
respective cultivar susceptibility categories. 
We will use this to estimate what the earliest estimate epidemic onset date when
canopy closure date is used as the start date of the model.  

```{r cDIV_min_thresholds}
min_resistant <- 12
min_susceptible <- 7
```

Get the difference between minimum cDIV values of resistant and susceptible 
cultivars

```{r cDIV_diff}
min_diff <- min_resistant - min_susceptible
min_diff
```
  
Find average change in cDIV per BBCH scale value of susceptibility.  

We will divide the difference in the minimum cDIV values for 'low' and 'highly' 
susceptible varieties by the model coefficient. 
This will provide an estimate of the difference, in DIV values between, 
varieties classified as 'low' and 'highly' susceptible in the Wolf study.  

```{r cDIV_coef}
cDIV_coef <- min_diff/coef(sus_mod)[2]
# remove the names
names(cDIV_coef) <- NULL
cDIV_coef
```

Now we have the cDIV coeficient we need to define an intercept.
The lm we used before was centered on the BBCH value of 4 we will use this for 
the intercept and adjust values beyond that

```{r}
# cDIV minumum for BBCH rated at 4 (stdev 3.91)

cDIV_threshold <- function(BBCH, intercept = 7, cdiv_coef = 3.9286){
  if(BBCH >= 4){
    BBCH <- (BBCH - 4)^(1/2)
  }else{
    BBCH <- 0-(abs(BBCH - 4)^(1/2))
  }
  
  #BBCH <- BBCH^(1/3)
intercept - BBCH * cdiv_coef  
}

sapply(1:9,cDIV_threshold,intercept = 13)
```


```{r}
bbch <- seq(1,9,by = 0.01)
plot(bbch, sapply(bbch,cDIV_threshold, intercept = 7), type = "l")
```

```{r}
cercospoRa::calc_susce
```

